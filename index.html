<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRPL — TrustSet + Payment Form</title>
  <style>
    :root {
      --bg: #0b0f14; --card: #121821; --ink: #e9eef3; --muted: #9fb0c0; --line:#233042;
      --accent: #2e7aef; --accent-2:#1f5dc0; --ok:#1fbf75; --err:#d9415a; --warn:#f4b740;
    }
    * { box-sizing: border-box; }
    body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif; background: var(--bg); color: var(--ink); margin: 0; padding: 24px; }
    .container { max-width: 980px; margin: auto; background: var(--card); padding: 28px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.35); border: 1px solid var(--line); }
    h1 { margin: 0 0 4px; font-size: 24px; }
    p.sub { margin: 0 0 18px; color: var(--muted); }

    form { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    fieldset { grid-column: 1 / -1; border: 1px solid var(--line); border-radius: 14px; padding: 14px; }
    legend { padding: 0 8px; color: #cfe1f5; font-size: 13px; }

    .col-6 { grid-column: span 6; }
    .col-4 { grid-column: span 4; }
    .col-3 { grid-column: span 3; }
    .col-12 { grid-column: span 12; }
    @media (max-width: 760px) { .col-6, .col-4, .col-3 { grid-column: span 12; } }

    label { display: block; margin-bottom: 6px; color: #c3d2e1; font-size: 13px; }
    input, select, textarea { width: 100%; padding: 12px 12px; border-radius: 12px; border: 1px solid #2c3b51; background: #0f141c; color: var(--ink); outline: none; }
    input:focus, select:focus, textarea:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(46,122,239,.18); }

    .row { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
    .hint { color: var(--muted); font-size: 12px; margin-top: 6px; }

    .controls { grid-column: 1 / -1; display: flex; gap: 12px; align-items: center; justify-content: flex-start; flex-wrap: wrap; margin-top: 4px; }
    button { background: var(--accent); color: #fff; border: 0; padding: 12px 16px; border-radius: 12px; font-weight: 700; cursor: pointer; }
    button:hover { background: var(--accent-2); }
    button.ghost { background: transparent; border: 1px solid var(--line); color: var(--ink); }
    button.danger { background: var(--err); }

    .banner { grid-column: 1 / -1; padding: 12px 14px; border-radius: 12px; border: 1px solid var(--line); background: #0e1620; display: none; }
    .banner.ok { display: block; border-color: #1a6f48; }
    .banner.err { display: block; border-color: #7a2431; }

    pre { background: #0b0f14; border: 1px solid var(--line); padding: 12px; border-radius: 12px; overflow: auto; margin-top: 16px; }

    .secret-wrap { position: relative; }
    .reveal { position: absolute; right: 8px; top: 34px; font-size: 12px; background: #17202b; border: 1px solid var(--line); padding: 6px 8px; border-radius: 10px; cursor: pointer; }
  </style>
</head>
<body>
  <div class="container">
    <h1>XRPL — TrustSet + Payment</h1>
    <p class="sub">Fill the fields, submit, and the server will run your script.</p>

    <form id="txForm" novalidate>
      <fieldset>
        <legend>Secrets</legend>
        <div class="row">
          <div class="col-6 secret-wrap">
  <label for="issuerSecret">Issuer Secret</label>
  <input type="password" id="issuerSecret" name="issuerSecret" placeholder="sEd…" required />
  <button type="button" class="reveal" data-toggle="issuerSecret">Show</button>

  <!-- Derived values from backend -->
  <div class="hint" style="margin-top:6px;">
    <strong>Address:</strong> <span id="issuerAddrText">—</span>
  </div>
  <div class="hint" style="margin-top:4px;">
    <strong>Public Key:</strong> <span id="issuerPubKeyText">—</span>
  </div>
</div>

          <div class="col-6">
            <label for="mode">Mode</label>
            <select id="mode" name="mode">
              <option value="both">Both seeds (full flow)</option>
              <option value="issuer-only">Issuer seed + investor address (issue & freeze)</option>
            </select>
          </div>

          <div class="col-6 secret-wrap" id="holderSecretWrap">
            <label for="holderSecret">Holder Secret</label>
            <input type="password" id="holderSecret" name="holderSecret" placeholder="sEd…" />
            <button type="button" class="reveal" data-toggle="holderSecret">Show</button>
          </div>

          <div class="col-6" id="holderAddressWrap">
            <label for="holderAddress">Investor Address (r…)</label>
            <input
              type="text"
              id="holderAddress"
              name="holderAddress"
              placeholder="r..."
              pattern="^r[1-9A-HJ-NP-Za-km-z]{25,34}$"
              autocomplete="off"
              autocapitalize="off"
              autocorrect="off"
              spellcheck="false"
            />
            <div class="hint">Use either Investor Secret (classic flow) or Investor Address (issue-only with existing trustline).</div>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Token & TrustLine</legend>
        <div class="row">
          <div class="col-6">
            <label for="currencyCode">Currency Code</label>
            <input type="text" id="currencyCode" name="currencyCode" placeholder="GDCP20251029" required />
          </div>
          <div class="col-3">
            <label for="amount">Amount</label>
            <input type="number" id="amount" name="amount" placeholder="10000000" required />
          </div>
          <div class="col-3" id="limitWrap">
            <label for="limit">Trust Limit</label>
            <input type="number" id="limit" name="limit" placeholder="100000000" />
            <div class="hint">Required only when creating the holder trustline (classic mode).</div>
          </div>
          <div class="col-6">
            <label for="freeze">Freeze after payment?</label>
            <select id="freeze" name="freeze">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Network</legend>
        <div class="row">
          <div class="col-4">
            <label for="network">Network</label>
            <select id="network" name="network">
              <option value="mainnet1">mainnet1</option>
              <option value="mainnet2">mainnet2</option>
              <option value="testnet">testnet</option>
            </select>
          </div>
          <div class="col-4">
            <label for="verbose">Verbose</label>
            <select id="verbose" name="verbose">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>
      </fieldset>

      <div class="controls">
        <button id="submitBtn" type="submit">Submit</button>
        <button id="resetBtn" type="button" class="ghost">Reset</button>
      </div>

      <div id="banner" class="banner"></div>
      <pre id="output" class="col-12">(waiting)</pre>
    </form>
  </div>

  <!-- Prefer xrpl browser build; also load ripple-keypairs as a fallback -->
  <script>
    // Live address + public key preview under Issuer Secret
    (function () {
      const seedEl  = document.getElementById('issuerSecret');
      const addrRow = document.getElementById('issuerAddrRow');
      const addrTxt = document.getElementById('issuerAddrText');
      const pubRow  = document.getElementById('issuerPubKeyRow');
      const pubTxt  = document.getElementById('issuerPubKeyText');

      if (!seedEl || !addrRow || !pubRow) return;

      function show(addr, pub) {
        addrRow.style.display = 'block';
        pubRow.style.display  = 'block';
        addrTxt.textContent   = addr;
        pubTxt.textContent    = pub;
      }
      function showMsg(msg) {
        addrRow.style.display = 'block';
        pubRow.style.display  = 'block';
        addrTxt.textContent   = msg;
        pubTxt.textContent    = msg;
      }

      function updatePreview() {
        const seed = (seedEl.value || '').trim();
        if (!seed) {
          addrRow.style.display = 'none';
          pubRow.style.display  = 'none';
          addrTxt.textContent   = '';
          pubTxt.textContent    = '';
          return;
        }

        // Try xrpl.js first
        try {
          if (window.xrpl && window.xrpl.Wallet) {
            const w = xrpl.Wallet.fromSeed(seed);
            return show(w.classicAddress, w.publicKey); // r... and ED...
          }
        } catch (e) {
          // fall through
        }

        // Fallback to ripple-keypairs UMD
        try {
          const kp = window.rippleKeypairs || window['ripple-keypairs']; // global name varies by bundler
          if (!kp) throw new Error('ripple-keypairs not loaded');
          const pair = kp.deriveKeypair(seed);           // { publicKey, privateKey } (hex)
          const addr = kp.deriveAddress(pair.publicKey); // r...
          return show(addr, pair.publicKey.toUpperCase());
        } catch (e2) {
          return showMsg('XRPL libraries not available');
        }
      }

      document.addEventListener('DOMContentLoaded', updatePreview);
      seedEl.addEventListener('input', updatePreview);
    })();
  </script>

  <script>
    // --- Existing form logic (unchanged apart from earlier clean-ups) ---
    const form = document.getElementById('txForm');
    const output = document.getElementById('output');
    const banner = document.getElementById('banner');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');

    const mode = document.getElementById('mode');
    const holderSecretWrap = document.getElementById('holderSecretWrap');
    const holderAddressWrap = document.getElementById('holderAddressWrap');
    const limitWrap = document.getElementById('limitWrap');

    document.querySelectorAll('.reveal').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-toggle');
        const input = document.getElementById(id);
        const type = input.type === 'password' ? 'text' : 'password';
        input.type = type;
        btn.textContent = type === 'password' ? 'Show' : 'Hide';
      });
    });

    function applyMode() {
      const issuerOnly = mode.value === 'issuer-only';
      holderSecretWrap.style.display = issuerOnly ? 'none' : 'block';
      holderAddressWrap.style.display = issuerOnly ? 'block' : 'none';
      limitWrap.style.display = issuerOnly ? 'none' : 'block';

      if (issuerOnly) {
        document.getElementById('holderSecret').value = '';
      } else {
        document.getElementById('holderAddress').value = '';
      }
    }
    mode.addEventListener('change', applyMode);
    applyMode();

    resetBtn?.addEventListener('click', () => {
      form.reset();
      applyMode();
      output.textContent = '(waiting)';
      banner.className = 'banner';
      banner.textContent = '';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      banner.className = 'banner';
      banner.textContent = '';
      output.textContent = 'Submitting…';
      submitBtn.disabled = true;

      const issuerOnly = mode.value === 'issuer-only';
      const holderSecret = issuerOnly ? '' : (form.holderSecret?.value || '');

      const data = {
        issuerSecret: form.issuerSecret.value,
        holderSecret: holderSecret || undefined,
        currencyCode: form.currencyCode.value,
        amount: form.amount.value,
        limit: form.limit.value,
        freeze: form.freeze.value === 'true',
        network: form.network.value,
        verbose: form.verbose.value === 'true'
      };
      if ('limit' in data && (data.limit === '' || data.limit == null)) delete data.limit;

      const CLASSIC_ADDR = /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/;
      const cleanAddr = (a) => (a ?? '').trim().replace(/\u200B/g, '');

      if (issuerOnly) {
        const raw = document.querySelector('#holderAddress')?.value ?? '';
        const addr = cleanAddr(raw);
        if (!addr || !CLASSIC_ADDR.test(addr)) {
          banner.className = 'banner err';
          banner.textContent = 'Investor address format looks invalid.';
          output.textContent = '(address pattern mismatch)';
          submitBtn.disabled = false;
          return;
        }
        data.investorAddress = addr;
      }

      const hasHolder = !!data.holderSecret;
      const hasInvestorAddr = !!data.investorAddress;

      if (issuerOnly && !hasInvestorAddr) {
        banner.className = 'banner err';
        banner.textContent = 'Investor address is required in Issuer-only mode.';
        output.textContent = '(missing investor address)';
        submitBtn.disabled = false;
        return;
      }
      if (!issuerOnly && !hasHolder) {
        banner.className = 'banner err';
        banner.textContent = 'Holder secret is required in classic mode.';
        output.textContent = '(missing holder secret)';
        submitBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch('/api/xrpl/execute', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        const contentType = res.headers.get('content-type') || '';
        const rawText = await res.text();
        const parsed = contentType.includes('application/json') ? (JSON.parse(rawText || '{}')) : rawText;

        if (!res.ok) {
          banner.className = 'banner err';
          banner.textContent = `HTTP ${res.status} ${res.statusText}`;
          output.textContent = typeof parsed === 'string' ? rawText : JSON.stringify(parsed, null, 2);
          return;
        }
        banner.className = 'banner ok';
        banner.textContent = 'Success';
        output.textContent = typeof parsed === 'string' ? rawText : JSON.stringify(parsed, null, 2);
      } catch (err) {
        banner.className = 'banner err';
        banner.textContent = 'Network error';
        output.textContent = 'Network/Fetch error: ' + (err?.message || err);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
  <script>
  (function () {
    const seedEl = document.getElementById('issuerSecret');
    const addrEl = document.getElementById('issuerAddrText');
    const pubEl  = document.getElementById('issuerPubKeyText');

    if (!seedEl || !addrEl || !pubEl) return;

    let t = null;
    const debounce = (fn, ms=250) => (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };

    async function derive(seed) {
      addrEl.textContent = '…';
      pubEl.textContent  = '…';

      if (!seed) {
        addrEl.textContent = '—';
        pubEl.textContent  = '—';
        return;
      }

      try {
        const res = await fetch('/api/derive', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ seed })
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || !data || !data.ok) {
          const msg = (data && (data.message || data.error)) || `HTTP ${res.status}`;
          addrEl.textContent = `Invalid seed — ${msg}`;
          pubEl.textContent  = `Invalid seed — ${msg}`;
          return;
        }

        addrEl.textContent = data.address || '(n/a)';
        pubEl.textContent  = data.publicKey || '(n/a)';
      } catch (err) {
        addrEl.textContent = 'Error contacting backend';
        pubEl.textContent  = 'Error contacting backend';
      }
    }

    const onInput = debounce(() => derive(seedEl.value.trim()), 300);
    seedEl.addEventListener('input', onInput);
    document.addEventListener('DOMContentLoaded', onInput);
  })();
</script>

</body>
</html>
