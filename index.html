<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRPL IOU Issuance Form</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0b1220; --muted:#5b6b7c; --line:#e6ebf1;
      --card:#f8fafc; --accent:#2563eb; --accent-2:#1d4ed8; --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .container{max-width:1060px;margin:28px auto;padding:20px}
    h1{margin:0 0 12px;font-size:22px}
    p.sub{margin:0 0 18px;color:var(--muted)}

    form{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    fieldset{grid-column:1/-1;border:1px solid var(--line);background:#fff;border-radius:12px;padding:14px}
    legend{padding:0 8px;color:#324968;font-size:12px}

    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:12px}
    .col-12{grid-column:span 12}
    .col-8{grid-column:span 8}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    @media(max-width:860px){.col-8,.col-6,.col-4,.col-3{grid-column:span 12}}

    label{display:block;margin:0 0 6px;color:#2a3c54;font-size:13px}
    input,select{width:100%;padding:12px 12px;border:1px solid var(--line);border-radius:12px;background:#fff;color:var(--ink);outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(37,99,235,.15)}

    .secret-wrap{position:relative}
    .reveal{position:absolute;right:8px;top:34px;padding:8px 12px;border-radius:10px;border:0;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}
    .reveal:hover{background:var(--accent-2)}

    .hint{margin-top:6px;font-size:12px;color:var(--muted)}
    .kv{margin-top:6px;font-size:13px}
    .kv strong{color:#2a3c54}

    .cards{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media(max-width:860px){.cards{grid-template-columns:1fr}}

    .card{border:1px solid var(--line);background:#fff;border-radius:12px;padding:14px}

    .controls{grid-column:1/-1;display:flex;gap:12px;margin-top:4px}
    button.primary{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button.primary:hover{background:var(--accent-2)}
    button.ghost{background:#fff;border:1px solid var(--line);color:var(--ink);border-radius:12px;padding:12px 16px}

    .banner{grid-column:1/-1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;display:none}
    .banner.ok{display:block;border-color:#cce9d6;background:#f0fdf4}
    .banner.err{display:block;border-color:#f3c1c1;background:#fff1f1}

    pre{grid-column:1/-1;background:#fff;border:1px solid var(--line);padding:12px;border-radius:12px;overflow:auto;margin-top:4px}

    /* input widths */
    #amount{max-width:220px}
    #issuerSecret{max-width:100%}
  </style>
</head>
<body>
  <div class="container">
    <h1>XRPL IOU Issuance Form</h1>
    <p class="sub">Issue an IOU to an investor and optionally freeze the trustline after payment.</p>

    <form id="txForm" novalidate>
      <fieldset>
        <legend>Secrets</legend>
        <div class="row">
          <div class="col-12 secret-wrap">
            <label for="issuerSecret">Issuer Secret</label>
            <input type="password" id="issuerSecret" name="issuerSecret" placeholder="sEd…" required />
            <button type="button" class="reveal" data-toggle="issuerSecret">Show</button>
            <div class="kv" id="issuerAddrRow" style="display:none;">
              <strong>Address:</strong> <span id="issuerAddrText"></span>
            </div>
            <div class="hint">Seed never leaves your browser except when you submit.</div>
          </div>

          <div class="col-6">
            <label for="mode">Mode</label>
            <select id="mode" name="mode">
              <option value="issuer-only" selected>Issuer seed + investor address (issue &amp; freeze)</option>
              <option value="both">Both seeds (full flow)</option>
            </select>
          </div>

          <div class="col-6" id="holderAddressWrap">
            <label for="holderAddress">Investor Address (r…)</label>
            <input id="holderAddress" name="holderAddress" placeholder="r..." pattern="^r[1-9A-HJ-NP-Za-km-z]{25,34}$" />
            <div class="hint">Use either Investor Secret (classic flow) or Investor Address (issuer-only with existing trustline).</div>
          </div>

          <div class="col-6 secret-wrap" id="holderSecretWrap" style="display:none">
            <label for="holderSecret">Holder Secret</label>
            <input type="password" id="holderSecret" name="holderSecret" placeholder="sEd…" />
            <button type="button" class="reveal" data-toggle="holderSecret">Show</button>
          </div>
        </div>
      </fieldset>

      <div class="cards">
        <div class="card">
          <div class="row">
            <div class="col-12">
              <legend style="padding:0 0 8px;display:block;color:#324968;font-size:12px">Token &amp; Trustline</legend>
            </div>
            <div class="col-6">
              <label for="currencyCode">Currency Code</label>
              <input id="currencyCode" name="currencyCode" placeholder="GDCP20251110" required />
            </div>
            <div class="col-6">
              <label for="amount">Amount</label>
              <input type="number" id="amount" name="amount" step="any" placeholder="115000" required />
            </div>
            <div class="col-6">
              <label for="freeze">Freeze after payment?</label>
              <select id="freeze" name="freeze">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
            <div class="col-6" id="limitWrap" style="display:none">
              <label for="limit">Trust Limit</label>
              <input type="number" id="limit" name="limit" placeholder="100000000" />
              <div class="hint">Required only when creating the holder trustline (classic mode).</div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="row">
            <div class="col-12">
              <legend style="padding:0 0 8px;display:block;color:#324968;font-size:12px">Network</legend>
            </div>
            <div class="col-6">
              <label for="network">Network</label>
              <select id="network" name="network">
                <option value="mainnet1">mainnet1</option>
                <option value="mainnet2">mainnet2</option>
                <option value="testnet" selected>testnet</option>
              </select>
            </div>
            <div class="col-6">
              <label for="verbose">Verbose</label>
              <select id="verbose" name="verbose">
                <option value="true">true</option>
                <option value="false" selected>false</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit" class="primary">Submit</button>
        <button id="resetBtn" type="button" class="ghost">Reset</button>
      </div>

      <div id="banner" class="banner"></div>
      <pre id="output">(waiting)</pre>
    </form>
  </div>

  <script>
    // Reveal buttons -> Show/Hide
    document.querySelectorAll('.reveal').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const id = btn.getAttribute('data-toggle');
        const el = document.getElementById(id);
        const to = el.type === 'password' ? 'text':'password';
        el.type = to;
        btn.textContent = to === 'password' ? 'Show' : 'Hide';
      });
    });

    const form = document.getElementById('txForm');
    const banner = document.getElementById('banner');
    const output = document.getElementById('output');
    const submitBtn = document.getElementById('submitBtn');

    const modeSel = document.getElementById('mode');
    const holderSecretWrap = document.getElementById('holderSecretWrap');
    const holderAddressWrap = document.getElementById('holderAddressWrap');
    const limitWrap = document.getElementById('limitWrap');

    function applyMode(){
      const issuerOnly = modeSel.value === 'issuer-only';
      holderSecretWrap.style.display = issuerOnly ? 'none':'block';
      holderAddressWrap.style.display = issuerOnly ? 'block':'none';
      limitWrap.style.display = issuerOnly ? 'none':'block';
      if (issuerOnly){ document.getElementById('holderSecret').value=''; }
      else { document.getElementById('holderAddress').value=''; }
    }
    modeSel.addEventListener('change', applyMode);
    applyMode();

    // --- Seed -> Classic address (via backend) ---
    const seedInput = document.getElementById('issuerSecret');
    const addrRow = document.getElementById('issuerAddrRow');
    const addrText = document.getElementById('issuerAddrText');
    let seedTimer = null;

    async function deriveAddress(seed){
      try{
        const res = await fetch('/api/derive', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ seed })
        });
        if(!res.ok) throw new Error('HTTP '+res.status);
        const data = await res.json(); // expected { address: "r..." }
        return data.address || '';
      }catch(e){
        return '';
      }
    }

    function showIssuerAddress(text, isError){
      addrRow.style.display = 'block';
      addrText.textContent = text;
      addrText.style.color = isError ? '#b4232c' : 'inherit';
    }

    seedInput.addEventListener('input', ()=>{
      const v = (seedInput.value||'').trim();
      if (!v){ addrRow.style.display='none'; addrText.textContent=''; return; }
      showIssuerAddress('…', false);
      clearTimeout(seedTimer);
      seedTimer = setTimeout(async ()=>{
        const addr = await deriveAddress(v);
        if(!addr){ showIssuerAddress('Invalid seed', true); }
        else { showIssuerAddress(addr, false); }
      }, 250);
    });

    // --- Submit handler ---
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      banner.className='banner';
      banner.textContent='';
      output.textContent='Submitting…';
      submitBtn.disabled=true;

      const issuerOnly = modeSel.value === 'issuer-only';
      const CLASSIC_ADDR = /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/;
      const clean = s => (s??'').trim().replace(/\u200B/g,'');

      const data = {
        issuerSecret: clean(form.issuerSecret.value),
        holderSecret: issuerOnly ? undefined : clean(form.holderSecret.value),
        currencyCode: clean(form.currencyCode.value),
        amount:      clean(form.amount.value),
        freeze:      form.freeze.value === 'true',
        network:     form.network.value,
        verbose:     form.verbose.value === 'true'
      };

      if (!issuerOnly){
        // classic mode requires limit
        const lim = clean(form.limit.value);
        if (lim) data.limit = lim;
      } else {
        const invRaw = clean(form.holderAddress.value);
        if (!invRaw || !CLASSIC_ADDR.test(invRaw)){
          banner.className='banner err';
          banner.textContent='Investor address format looks invalid.';
          output.textContent='(address pattern mismatch)';
          submitBtn.disabled=false;
          return;
        }
        data.investorAddress = invRaw;
      }

      // Normalize possible mainnet aliases
      if (data.network === 'mainnet1' || data.network === 'mainnet2') data.network = 'mainnet';

      try{
        const res = await fetch('/api/xrpl/execute', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        const ct = res.headers.get('content-type') || '';
        const raw = await res.text();
        const parsed = ct.includes('application/json') ? (JSON.parse(raw||'{}')) : raw;

        if (!res.ok){
          banner.className='banner err';
          banner.textContent=`HTTP ${res.status} ${res.statusText}`;
          output.textContent = typeof parsed==='string' ? raw : JSON.stringify(parsed,null,2);
          return;
        }
        banner.className='banner ok';
        banner.textContent='Success';
        output.textContent = typeof parsed==='string' ? raw : JSON.stringify(parsed,null,2);
      }catch(err){
        banner.className='banner err';
        banner.textContent='Network error';
        output.textContent = 'Network/Fetch error: ' + (err?.message||err);
      }finally{
        submitBtn.disabled=false;
      }
    });

    // Reset
    document.getElementById('resetBtn').addEventListener('click', ()=>{
      form.reset();
      applyMode();
      addrRow.style.display='none'; addrText.textContent='';
      banner.className='banner'; banner.textContent='';
      output.textContent='(waiting)';
    });
  </script>
</body>
</html>
