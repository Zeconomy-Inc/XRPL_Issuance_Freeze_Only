<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRPL IOU Issuance Form</title>

  <style>
    :root{
      --bg:#ffffff; --ink:#0f172a; --muted:#475569; --line:#e2e8f0;
      --primary:#2563eb; --primary-2:#1d4ed8; --input:#f8fafc;
      --ok:#16a34a; --err:#dc2626;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink); font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Roboto,Arial}
    .wrap{max-width:1000px; margin:40px auto; padding:0 20px}
    h1{margin:0 0 8px; font-size:34px; letter-spacing:.3px}
    .sub{margin:0 0 22px; color:var(--muted)}

    /* simple form layout */
    form{display:grid; grid-template-columns: repeat(12,1fr); gap:16px}
    .row-12{grid-column:1/-1}
    .row-6{grid-column:span 6}
    .row-4{grid-column:span 4}
    .row-3{grid-column:span 3}
    @media (max-width: 860px){ .row-6,.row-4,.row-3{grid-column:1/-1}}

    label{display:block; font-weight:600; margin:6px 0 6px}
    .hint{color:var(--muted); font-size:12px; margin-top:6px}
    input,select,textarea{
      width:100%; padding:12px 12px; border:1px solid var(--line); background:var(--input);
      border-radius:12px; outline:none
    }
    input:focus,select:focus,textarea:focus{border-color:var(--primary); box-shadow:0 0 0 4px rgba(37,99,235,.12)}
    .inline{display:flex; gap:10px; align-items:center}
    .inline > *{flex:1}

    .btn{display:inline-flex; align-items:center; justify-content:center; padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:700}
    .btn.primary{background:var(--primary); color:#fff}
    .btn.primary:hover{background:var(--primary-2)}
    .btn.ghost{background:#fff; border:1px solid var(--line); color:var(--ink)}
    .btn.small{padding:10px 14px}
    .actions{grid-column:1/-1; display:flex; gap:12px; margin-top:6px}

    .banner{grid-column:1/-1; display:none; padding:12px 14px; border-radius:12px; border:1px solid var(--line)}
    .banner.ok{display:block; border-color:#16a34a1f; background:#f0fdf4}
    .banner.err{display:block; border-color:#dc26261f; background:#fef2f2}

    pre{grid-column:1/-1; background:#0b1220; color:#e2e8f0; border-radius:12px; padding:12px; overflow:auto; border:1px solid #0f172a}
    .right{justify-content:flex-end}

    /* show/hide pill next to password */
    .reveal{margin-left:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>XRPL IOU Issuance Form</h1>
    <p class="sub">Issue an IOU to an investor and optionally freeze the trustline after payment.</p>

    <form id="txForm" novalidate>
      <!-- Secrets -->
      <div class="row-12"><strong>Secrets</strong></div>

      <div class="row-12">
        <label for="issuerSecret">Issuer Secret</label>
        <div class="inline">
          <input type="password" id="issuerSecret" name="issuerSecret" placeholder="sEd…" required />
          <button type="button" class="btn primary small reveal" data-toggle="issuerSecret">Show</button>
        </div>
        <div class="hint">Seed never leaves your browser except when you submit.</div>
      </div>

      <div class="row-6">
        <label for="mode">Mode</label>
        <select id="mode" name="mode">
          <option value="both">Both seeds (full flow)</option>
          <option value="issuer-only" selected>Issuer seed + investor address (issue & freeze)</option>
        </select>
      </div>

      <div class="row-6" id="holderAddressWrap">
        <label for="holderAddress">Investor Address (r…)</label>
        <input type="text" id="holderAddress" name="holderAddress" placeholder="r..." pattern="^r[1-9A-HJ-NP-Za-km-z]{25,34}$" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" />
        <div class="hint">Use either Investor Secret (classic flow) or Investor Address (issuer-only with existing trustline).</div>
      </div>

      <div class="row-6" id="holderSecretWrap" style="display:none">
        <label for="holderSecret">Holder Secret</label>
        <div class="inline">
          <input type="password" id="holderSecret" name="holderSecret" placeholder="sEd…" />
          <button type="button" class="btn primary small reveal" data-toggle="holderSecret">Show</button>
        </div>
      </div>

      <!-- Token & Trustline -->
      <div class="row-12"><strong>Token & Trustline</strong></div>

      <div class="row-6">
        <label for="currencyCode">Currency Code</label>
        <input type="text" id="currencyCode" name="currencyCode" placeholder="GDCP20251110" required />
      </div>

      <div class="row-6">
        <label for="amount">Amount</label>
        <input type="number" id="amount" name="amount" placeholder="115000" required />
      </div>

      <div class="row-6" id="limitWrap" style="display:none">
        <label for="limit">Trust Limit</label>
        <input type="number" id="limit" name="limit" placeholder="100000000" />
        <div class="hint">Required only when creating the holder trustline (classic mode).</div>
      </div>

      <div class="row-6">
        <label for="freeze">Freeze after payment?</label>
        <select id="freeze" name="freeze">
          <option value="true">true</option>
          <option value="false">false</option>
        </select>
      </div>

      <!-- Network -->
      <div class="row-12"><strong>Network</strong></div>

      <div class="row-6">
        <label for="network">Network</label>
        <select id="network" name="network">
          <option value="testnet">testnet</option>
          <option value="mainnet1">mainnet1</option>
          <option value="mainnet2">mainnet2</option>
        </select>
      </div>

      <div class="row-6">
        <label for="verbose">Verbose</label>
        <select id="verbose" name="verbose">
          <option value="false">false</option>
          <option value="true">true</option>
        </select>
      </div>

      <!-- Actions -->
      <div id="banner" class="banner row-12"></div>

      <div class="actions right">
        <button id="submitBtn" type="submit" class="btn primary">Submit</button>
        <button id="resetBtn" type="button" class="btn ghost">Reset</button>
      </div>

      <pre id="output">(waiting)</pre>
    </form>
  </div>

  <script>
    // toggle password show/hide
    document.querySelectorAll('.reveal').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-toggle');
        const input = document.getElementById(id);
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        btn.textContent = isPwd ? 'Hide' : 'Show';
      });
    });

    // mode toggle
    const mode = document.getElementById('mode');
    const holderSecretWrap = document.getElementById('holderSecretWrap');
    const holderAddressWrap = document.getElementById('holderAddressWrap');
    const limitWrap = document.getElementById('limitWrap');
    function applyMode() {
      const issuerOnly = mode.value === 'issuer-only';
      holderSecretWrap.style.display = issuerOnly ? 'none' : 'block';
      holderAddressWrap.style.display = issuerOnly ? 'block' : 'none';
      limitWrap.style.display = issuerOnly ? 'none' : 'block';
      if (issuerOnly) document.getElementById('holderSecret').value = '';
      else document.getElementById('holderAddress').value = '';
    }
    mode.addEventListener('change', applyMode);
    applyMode(); // default issuer-only

    // submit
    const form = document.getElementById('txForm');
    const output = document.getElementById('output');
    const banner = document.getElementById('banner');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');

    resetBtn.addEventListener('click', () => {
      form.reset();
      applyMode();
      banner.className = 'banner';
      banner.textContent = '';
      output.textContent = '(waiting)';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      banner.className = 'banner';
      banner.textContent = '';
      output.textContent = 'Submitting…';
      submitBtn.disabled = true;

      const issuerOnly = mode.value === 'issuer-only';
      const data = {
        issuerSecret: form.issuerSecret.value,
        holderSecret: issuerOnly ? undefined : (form.holderSecret?.value || ''),
        currencyCode: form.currencyCode.value,
        amount: form.amount.value,
        limit: issuerOnly ? undefined : form.limit.value,
        freeze: form.freeze.value === 'true',
        network: form.network.value,
        verbose: form.verbose.value === 'true'
      };

      // validate investor address in issuer-only mode
      if (issuerOnly) {
        const addr = (form.holderAddress.value || '').trim().replace(/\u200B/g,'');
        const CLASSIC = /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/;
        if (!CLASSIC.test(addr)) {
          banner.className = 'banner err';
          banner.textContent = 'Investor address format looks invalid.';
          output.textContent = '(address pattern mismatch)';
          submitBtn.disabled = false;
          return;
        }
        data.investorAddress = addr;
      }

      try {
        const res = await fetch('/api/xrpl/execute', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        const text = await res.text();
        let parsed = text;
        try { parsed = JSON.parse(text); } catch {}
        if (!res.ok) {
          banner.className = 'banner err';
          banner.textContent = `HTTP ${res.status} ${res.statusText}`;
          output.textContent = typeof parsed === 'string' ? text : JSON.stringify(parsed, null, 2);
          return;
        }
        banner.className = 'banner ok';
        banner.textContent = 'Success';
        output.textContent = typeof parsed === 'string' ? text : JSON.stringify(parsed, null, 2);
      } catch (err) {
        banner.className = 'banner err';
        banner.textContent = 'Network error';
        output.textContent = 'Network/Fetch error: ' + (err?.message || err);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
