<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRPL IOU Issuance Form</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0b1220; --muted:#5b6b7f; --line:#e6e9ee;
      --accent:#2e6df6; --accent-2:#1f53c9; --err:#d9415a;
    }
    *{box-sizing:border-box}
    body{margin:0; background:var(--bg); color:var(--ink); font:16px/1.45 Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .page{max-width:1024px; margin:36px auto 64px; padding:0 24px}
    h1{margin:0 0 8px; font-size:34px; letter-spacing:.2px}
    p.lead{margin:0 0 24px; color:var(--muted)}
    form{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .row{grid-column:1/-1; display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
    .col-12{grid-column:span 12}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    @media (max-width:860px){
      .col-6,.col-4,.col-3{grid-column:span 12}
    }

    label{display:block; margin:6px 0 6px; font-size:14px; color:#1b2433}
    input,select,button{font:inherit}
    input,select{
      width:100%; padding:12px 12px; border:1px solid var(--line); border-radius:10px; background:#fff; color:var(--ink);
      outline:0; transition:border-color .15s, box-shadow .15s;
    }
    input:focus,select:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(46,109,246,.15)}
    .hint{font-size:12px; color:var(--muted); margin-top:6px}
    .addr-line{font-size:13px; margin-top:6px}
    .addr-line strong{font-weight:600}
    .addr-bad{color:var(--err)}
    .addr-ok{color:#176c46}

    .secret-wrap{position:relative}
    .reveal{
      position:absolute; right:8px; top:34px; padding:8px 12px; border-radius:10px; border:0; cursor:pointer;
      background:var(--accent); color:#fff; font-weight:600;
    }
    .reveal:hover{background:var(--accent-2)}

    .controls{grid-column:1/-1; display:flex; gap:12px; margin-top:8px}
    .btn{padding:12px 16px; border-radius:12px; border:0; cursor:pointer; font-weight:700}
    .btn.primary{background:var(--accent); color:#fff}
    .btn.primary:hover{background:var(--accent-2)}
    .btn.ghost{background:#f6f8fb; border:1px solid var(--line); color:var(--ink)}
    pre{grid-column:1/-1; background:#f7f9fc; border:1px solid var(--line); border-radius:12px; padding:12px; overflow:auto}

    /* inline groups for compact layout */
    .inline{display:grid; grid-template-columns:repeat(12,1fr); gap:16px}
  </style>
  <!-- Optional browser fallback if /api/derive is unavailable -->
  <script defer src="https://unpkg.com/xrpl@2.14.0/dist/browser/xrpl-latest-min.js"></script>
</head>
<body>
  <div class="page">
    <h1>XRPL IOU Issuance Form</h1>
    <p class="lead">Issue an IOU to an investor and optionally freeze the trustline after payment.</p>

    <form id="txForm" novalidate>
      <!-- Secrets / Mode -->
      <div class="row">
        <div class="col-6 secret-wrap">
          <label for="issuerSecret">Issuer Secret</label>
          <input type="password" id="issuerSecret" name="issuerSecret" placeholder="sEd…" autocomplete="off" />
          <button type="button" class="reveal" data-toggle="issuerSecret">Show</button>
          <div id="issuerAddrLine" class="addr-line"><strong>Address:</strong> <span id="issuerAddrText" class="addr-bad">Invalid seed</span></div>
          <div class="hint">Seed never leaves your browser except when you submit.</div>
        </div>

        <div class="col-3">
          <label for="mode">Mode</label>
          <select id="mode" name="mode">
            <option value="issuer-only" selected>Issuer seed + investor address (issue & freeze)</option>
            <option value="both">Both seeds (full flow)</option>
          </select>
        </div>

        <div class="col-3" id="holderAddressWrap">
          <label for="holderAddress">Investor Address (r…)</label>
          <input type="text" id="holderAddress" name="holderAddress" placeholder="r..." autocomplete="off" />
          <div class="hint">Use either Investor Secret (classic) or Investor Address (issuer-only with existing trustline).</div>
        </div>

        <div class="col-3" id="holderSecretWrap" style="display:none">
          <label for="holderSecret">Holder Secret</label>
          <input type="password" id="holderSecret" name="holderSecret" placeholder="sEd…" autocomplete="off" />
          <button type="button" class="reveal" data-toggle="holderSecret" style="right:8px; top:34px">Show</button>
        </div>
      </div>

      <!-- Token & Network in one inline row -->
      <div class="inline">
        <div class="col-3">
          <label for="currencyCode">Currency Code</label>
          <input type="text" id="currencyCode" name="currencyCode" placeholder="GDCP20251110" />
        </div>
        <div class="col-2">
          <label for="amount">Amount</label>
          <input type="number" id="amount" name="amount" placeholder="115000" />
        </div>
        <div class="col-2" id="limitWrap" style="display:none">
          <label for="limit">Trust Limit</label>
          <input type="number" id="limit" name="limit" placeholder="1000000" />
        </div>
        <div class="col-2">
          <label for="freeze">Freeze after payment?</label>
          <select id="freeze" name="freeze">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
        </div>
        <div class="col-2">
          <label for="network">Network</label>
          <select id="network" name="network">
            <option value="testnet">testnet</option>
            <option value="mainnet1">mainnet1</option>
            <option value="mainnet2">mainnet2</option>
          </select>
        </div>
        <div class="col-1">
          <label for="verbose">Verbose</label>
          <select id="verbose" name="verbose">
            <option value="false">false</option>
            <option value="true">true</option>
          </select>
        </div>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit" class="btn primary">Submit</button>
        <button id="resetBtn" type="button" class="btn ghost">Reset</button>
      </div>

      <pre id="output">(waiting)</pre>
    </form>
  </div>

  <script>
    // --- UI helpers
    const $ = (q) => document.querySelector(q);
    const CLASSIC_ADDR = /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/;
    const clean = (s) => (s ?? '').trim().replace(/\u200B/g,'');

    // Show/Hide buttons
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.reveal');
      if (!btn) return;
      const id = btn.getAttribute('data-toggle');
      const el = document.getElementById(id);
      if (!el) return;
      if (el.type === 'password') { el.type = 'text'; btn.textContent = 'Hide'; }
      else { el.type = 'password'; btn.textContent = 'Show'; }
    });

    // Mode toggle visibility
    const modeSel = $('#mode');
    const holderSecretWrap = $('#holderSecretWrap');
    const holderAddressWrap = $('#holderAddressWrap');
    const limitWrap = $('#limitWrap');

    function applyMode() {
      const issuerOnly = modeSel.value === 'issuer-only';
      holderSecretWrap.style.display = issuerOnly ? 'none' : 'block';
      holderAddressWrap.style.display = issuerOnly ? 'block' : 'none';
      limitWrap.style.display = issuerOnly ? 'none' : 'block';
      if (issuerOnly) { $('#holderSecret').value=''; } else { $('#holderAddress').value=''; }
    }
    modeSel.addEventListener('change', applyMode);
    applyMode();

    // --- Derive classic address under seed (prefer backend /api/derive; fallback to browser xrpl)
    const seedEl = $('#issuerSecret');
    const addrText = $('#issuerAddrText');
    const addrLine = $('#issuerAddrLine');

    let tDerive = 0;
    async function deriveClassic(seed) {
      // 1) Try backend helper
      try {
        const r = await fetch('/api/derive', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ seed })
        });
        if (r.ok) {
          const j = await r.json();
          if (j && j.address && CLASSIC_ADDR.test(j.address)) return j.address;
        }
      } catch(_) {}

      // 2) Fallback: browser XRPL
      try {
        if (window.xrpl?.Wallet) {
          const w = xrpl.Wallet.fromSeed(seed);
          return w?.classicAddress || '';
        }
      } catch(_) {}
      return '';
    }

    function updateSeedPreview() {
      const s = clean(seedEl.value);
      if (!s) {
        addrText.textContent = 'Enter seed';
        addrText.className = 'addr-bad';
        return;
      }
      clearTimeout(tDerive);
      tDerive = setTimeout(async () => {
        const addr = await deriveClassic(s);
        if (addr && CLASSIC_ADDR.test(addr)) {
          addrText.textContent = addr;
          addrText.className = 'addr-ok';
        } else {
          addrText.textContent = 'Invalid seed';
          addrText.className = 'addr-bad';
        }
      }, 200);
    }
    seedEl.addEventListener('input', updateSeedPreview);
    document.addEventListener('DOMContentLoaded', updateSeedPreview);

    // --- Submit
    const form = $('#txForm');
    const output = $('#output');
    const submitBtn = $('#submitBtn');
    const bannerSet = (msg,isErr=false) => {
      output.textContent = msg;
      output.style.borderColor = isErr ? '#f3c0c7' : 'var(--line)';
      output.style.background = isErr ? '#fff6f7' : '#f7f9fc';
    };

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      bannerSet('Submitting…');

      const issuerOnly = modeSel.value === 'issuer-only';
      const data = {
        issuerSecret: seedEl.value,
        holderSecret: issuerOnly ? undefined : $('#holderSecret').value || undefined,
        investorAddress: issuerOnly ? clean($('#holderAddress').value) : undefined,
        currencyCode: $('#currencyCode').value,
        amount: $('#amount').value,
        limit: $('#limit').value || undefined,
        freeze: $('#freeze').value === 'true',
        network: $('#network').value,
        verbose: $('#verbose').value === 'true'
      };

      try {
        const res = await fetch('/api/xrpl/execute', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(data)
        });
        const text = await res.text();
        const isJSON = (res.headers.get('content-type') || '').includes('application/json');
        const out = isJSON ? JSON.stringify(JSON.parse(text), null, 2) : text;
        if (!res.ok) {
          bannerSet(`HTTP ${res.status} ${res.statusText}\n\n${out}`, true);
        } else {
          bannerSet(out, false);
        }
      } catch(err){
        bannerSet('Network error: ' + (err?.message || err), true);
      } finally {
        submitBtn.disabled = false;
      }
    });

    // Reset
    $('#resetBtn').addEventListener('click', () => {
      form.reset();
      applyMode();
      updateSeedPreview();
      bannerSet('(waiting)');
    });
  </script>
</body>
</html>
