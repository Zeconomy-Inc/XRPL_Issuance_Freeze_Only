<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRPL IOU Issuance Form</title>
  <style>
    :root{
      --bg:#ffffff; --card:#ffffff; --ink:#0b1220; --muted:#6b7280; --line:#e5e7eb;
      --accent:#2563eb; --accent-2:#1e40af; --ok:#16a34a; --err:#dc2626; --warn:#f59e0b
    }
    *{box-sizing:border-box}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--ink);margin:0;padding:24px}
    .container{max-width:980px;margin:auto;background:var(--card);padding:28px;border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.06);border:1px solid var(--line)}
    h1{margin:0 0 4px;font-size:24px}
    p.sub{margin:0 0 18px;color:var(--muted)}
    form{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    fieldset{grid-column:1/-1;border:1px solid var(--line);border-radius:14px;padding:14px}
    legend{padding:0 8px;color:#334155;font-size:13px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-3{grid-column:span 3}.col-12{grid-column:span 12}
    @media (max-width:760px){.col-6,.col-4,.col-3{grid-column:span 12}}
    label{display:block;margin-bottom:6px;color:#334155;font-size:13px}
    input,select,textarea{width:100%;padding:12px 12px;border-radius:12px;border:1px solid #cbd5e1;background:#fff;color:var(--ink);outline:none}
    input:focus,select:focus,textarea:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(37,99,235,.15)}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .controls{grid-column:1/-1;display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:4px}
    button{background:var(--accent);color:#fff;border:0;padding:12px 16px;border-radius:12px;font-weight:700;cursor:pointer}
    button:hover{background:var(--accent-2)}
    button.ghost{background:transparent;border:1px solid var(--line);color:var(--ink)}
    .banner{grid-column:1/-1;padding:12px 14px;border-radius:12px;border:1px solid var(--line);background:#f8fafc;display:none}
    .banner.ok{display:block;border-color:#bbf7d0;background:#f0fdf4}
    .banner.err{display:block;border-color:#fecaca;background:#fff1f2}
    pre{background:#f8fafc;border:1px solid var(--line);padding:12px;border-radius:12px;overflow:auto;margin-top:16px}
    .secret-wrap{position:relative}
    .reveal{position:absolute;right:8px;top:34px;font-size:12px;padding:8px 10px;border-radius:10px}
    /* Make reveal/hide look like primary */
    .reveal{background:var(--accent);color:#fff;border:0}
    .reveal:hover{background:var(--accent-2)}
    /* Two fieldsets side-by-side on wide screens */
    .two-up{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    @media (max-width:900px){.two-up{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <h1>XRPL IOU Issuance Form</h1>
    <p class="sub">Enter issuer seed and investor address, choose token details, then submit.</p>

    <form id="txForm" novalidate>
      <fieldset>
        <legend>Secrets</legend>
        <div class="row">
          <div class="col-12 secret-wrap">
            <label for="issuerSecret">Issuer Secret</label>
            <input type="password" id="issuerSecret" name="issuerSecret" placeholder="sEd…" required />
            <button type="button" class="reveal" data-toggle="issuerSecret">Show</button>
            <div class="hint" id="issuerAddrRow" style="margin-top:6px;">
              <strong>Address:</strong> <span id="issuerAddrText">—</span>
            </div>
          </div>

          <div class="col-6">
            <label for="mode">Mode</label>
            <select id="mode" name="mode">
              <option value="both">Both seeds (full flow)</option>
              <option value="issuer-only" selected>Issuer seed + investor address (issue &amp; freeze)</option>
            </select>
          </div>

          <div class="col-6 secret-wrap" id="holderSecretWrap">
            <label for="holderSecret">Holder Secret</label>
            <input type="password" id="holderSecret" name="holderSecret" placeholder="sEd…" />
            <button type="button" class="reveal" data-toggle="holderSecret">Show</button>
          </div>

          <div class="col-12" id="holderAddressWrap">
            <label for="holderAddress">Investor Address (r…)</label>
            <input
              type="text"
              id="holderAddress"
              name="holderAddress"
              placeholder="r..."
              pattern="^r[1-9A-HJ-NP-Za-km-z]{25,34}$"
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
            />
            <div class="hint">Use either Investor Secret (classic flow) or Investor Address (issuer-only with existing trustline).</div>
          </div>
        </div>
      </fieldset>

      <!-- Two fieldsets side-by-side -->
      <div class="two-up">
        <fieldset>
          <legend>Token &amp; Trustline</legend>
          <div class="row">
            <div class="col-6">
              <label for="currencyCode">Currency Code</label>
              <input type="text" id="currencyCode" name="currencyCode" placeholder="GDCP20251110" required />
            </div>
            <div class="col-3">
              <label for="amount">Amount</label>
              <input type="number" id="amount" name="amount" placeholder="100000" required />
            </div>
            <div class="col-3" id="limitWrap">
              <label for="limit">Trust Limit</label>
              <input type="number" id="limit" name="limit" placeholder="100000000" />
              <div class="hint">Needed only when creating the holder trustline (classic mode).</div>
            </div>
            <div class="col-6">
              <label for="freeze">Freeze after payment?</label>
              <select id="freeze" name="freeze">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Network</legend>
          <div class="row">
            <div class="col-6">
              <label for="network">Network</label>
              <select id="network" name="network">
                <option value="mainnet1">mainnet1</option>
                <option value="mainnet2">mainnet2</option>
                <option value="testnet">testnet</option>
              </select>
            </div>
            <div class="col-6">
              <label for="verbose">Verbose</label>
              <select id="verbose" name="verbose">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
          </div>
        </fieldset>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit">Submit</button>
        <button id="resetBtn" type="button" class="ghost">Reset</button>
      </div>

      <div id="banner" class="banner"></div>
      <pre id="output" class="col-12">(waiting)</pre>
    </form>
  </div>

  <!-- Browser-only derivation of classic address from seed -->
  <script src="https://unpkg.com/ripple-keypairs@1.3.1/dist/ripple-keypairs.min.js"></script>
  <script>
    (function () {
      const seedEl  = document.getElementById('issuerSecret');
      const addrTxt = document.getElementById('issuerAddrText');
      const holderSecretWrap  = document.getElementById('holderSecretWrap');
      const holderAddressWrap = document.getElementById('holderAddressWrap');
      const limitWrap = document.getElementById('limitWrap');
      const modeSel   = document.getElementById('mode');

      // Toggle secrets by mode
      function applyMode(){
        const issuerOnly = modeSel.value === 'issuer-only';
        holderSecretWrap.style.display  = issuerOnly ? 'none'  : 'block';
        holderAddressWrap.style.display = issuerOnly ? 'block' : 'none';
        limitWrap.style.display         = issuerOnly ? 'none'  : 'block';
        if (issuerOnly) document.getElementById('holderSecret').value = '';
        else document.getElementById('holderAddress').value = '';
      }
      modeSel.addEventListener('change', applyMode);
      applyMode();

      // Reveal / Hide
      document.querySelectorAll('.reveal').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const id = btn.getAttribute('data-toggle');
          const input = document.getElementById(id);
          const t = input.type === 'password' ? 'text' : 'password';
          input.type = t;
          btn.textContent = t === 'password' ? 'Show' : 'Hide';
        });
      });

      // Classic address live preview
      function updateAddr(){
        const seed = (seedEl.value || '').trim();
        if(!seed){ addrTxt.textContent = '—'; return; }
        try{
          const kp = window.rippleKeypairs || window['ripple-keypairs'];
          if(!kp) throw new Error('keypairs lib missing');
          const pair = kp.deriveKeypair(seed);
          const addr = kp.deriveAddress(pair.publicKey);
          addrTxt.textContent = addr;
        }catch(e){
          addrTxt.textContent = 'Invalid seed';
        }
      }
      seedEl.addEventListener('input', updateAddr);
      document.addEventListener('DOMContentLoaded', updateAddr);
    })();
  </script>

  <script>
    // Submit logic (same as before)
    const form = document.getElementById('txForm');
    const output = document.getElementById('output');
    const banner = document.getElementById('banner');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');
    const mode = document.getElementById('mode');

    resetBtn?.addEventListener('click', () => {
      form.reset();
      output.textContent='(waiting)';
      banner.className='banner'; banner.textContent='';
      document.dispatchEvent(new Event('DOMContentLoaded'));
    });

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      banner.className='banner'; banner.textContent='';
      output.textContent='Submitting…'; submitBtn.disabled=true;

      const issuerOnly = mode.value === 'issuer-only';
      const data = {
        issuerSecret: form.issuerSecret.value,
        holderSecret: issuerOnly ? undefined : (form.holderSecret?.value || ''),
        currencyCode: form.currencyCode.value,
        amount: form.amount.value,
        limit: form.limit.value || undefined,
        freeze: form.freeze.value === 'true',
        network: form.network.value,
        verbose: form.verbose.value === 'true'
      };

      const CLASSIC_ADDR=/^r[1-9A-HJ-NP-Za-km-z]{25,34}$/;
      const clean=(s)=> (s??'').trim().replace(/\u200B/g,'');
      if(issuerOnly){
        const addr=clean(form.holderAddress.value);
        if(!addr||!CLASSIC_ADDR.test(addr)){
          banner.className='banner err';
          banner.textContent='Investor address format looks invalid.';
          output.textContent='(address pattern mismatch)'; submitBtn.disabled=false; return;
        }
        data.investorAddress=addr;
      }

      try{
        const res=await fetch('/api/xrpl/execute',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const txt=await res.text(); const isJSON=(res.headers.get('content-type')||'').includes('application/json');
        const payload=isJSON?JSON.parse(txt||'{}'):txt;
        if(!res.ok){ banner.className='banner err'; banner.textContent=`HTTP ${res.status} ${res.statusText}`; output.textContent=isJSON?JSON.stringify(payload,null,2):txt; return; }
        banner.className='banner ok'; banner.textContent='Success';
        output.textContent=isJSON?JSON.stringify(payload,null,2):txt;
      }catch(err){
        banner.className='banner err'; banner.textContent='Network error';
        output.textContent='Network/Fetch error: '+(err?.message||err);
      }finally{ submitBtn.disabled=false; }
    });
  </script>
</body>
</html>
