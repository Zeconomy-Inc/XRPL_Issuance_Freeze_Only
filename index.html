<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRPL IOU Issuance Form</title>
  <style>
    :root{
      --bg:#ffffff; --ink:#0b0f14; --muted:#5b6b7a; --line:#dfe6ee;
      --card:#f8fafc; --accent:#2e7aef; --accent-2:#1f5dc0;
      --ok:#1fbf75; --err:#d9415a;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:14px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif}
    .container{max-width:1000px;margin:24px auto;padding:24px;border:1px solid var(--line);border-radius:14px;background:#fff}
    h1{margin:0 0 6px;font-size:22px}
    p.sub{margin:0 0 18px;color:var(--muted)}

    form{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    fieldset{border:1px solid var(--line);border-radius:12px;padding:14px;background:var(--card)}
    legend{padding:0 8px;font-size:12px;color:#334155}

    .col-12{grid-column:1 / -1}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    @media (max-width: 820px){
      .col-6,.col-4{grid-column:1 / -1}
      .two-up{grid-template-columns:1fr !important}
    }

    label{display:block;margin:0 0 6px;color:#334155;font-size:13px}
    input,select{width:100%;padding:12px;border-radius:10px;border:1px solid #c9d4e0;background:#fff;color:var(--ink);outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(46,122,239,.18)}

    .hint{color:var(--muted);font-size:12px;margin-top:6px}
    .controls{grid-column:1 / -1;display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{appearance:none;border:0;border-radius:10px;padding:12px 16px;font-weight:700;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff}
    .btn-primary:hover{background:var(--accent-2)}
    .btn-ghost{background:#fff;border:1px solid var(--line);color:var(--ink)}

    .banner{grid-column:1 / -1;padding:12px 14px;border-radius:10px;border:1px solid var(--line);display:none}
    .banner.ok{display:block;border-color:#1a6f48;background:#e7f7ef}
    .banner.err{display:block;border-color:#7a2431;background:#fde7ea}

    pre{background:#f6f8fa;border:1px solid var(--line);padding:12px;border-radius:10px;overflow:auto;margin-top:10px}
    .secret-wrap{position:relative}
    .reveal{position:absolute;right:8px;top:34px}
    /* Make Show/Hide buttons look like Submit */
    .reveal.btn{background:var(--accent);color:#fff}
    .reveal.btn:hover{background:var(--accent-2)}

    /* Side-by-side sections */
    .two-up{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  </style>
</head>
<body>
  <div class="container">
    <h1>XRPL IOU Issuance Form</h1>
    <p class="sub">Enter issuer seed and investor address, then submit to issue (and optionally freeze) IOUs.</p>

    <form id="txForm" novalidate>
      <fieldset class="col-12">
        <legend>Secrets</legend>
        <div class="row">
          <div class="col-12 secret-wrap">
            <label for="issuerSecret">Issuer Secret</label>
            <input type="password" id="issuerSecret" name="issuerSecret" placeholder="sEd…" required />
            <button type="button" class="reveal btn btn-primary" data-toggle="issuerSecret">Show</button>
            <div class="hint" id="issuerAddrRow" style="margin-top:6px;display:none;">
              <strong>Issuer Address:</strong> <span id="issuerAddrText"></span>
            </div>
          </div>

          <div class="col-6">
            <label for="mode">Mode</label>
            <select id="mode" name="mode">
              <option value="issuer-only" selected>Issuer seed + investor address (issue & freeze)</option>
              <option value="both">Both seeds (classic)</option>
            </select>
          </div>

          <div class="col-6" id="holderSecretWrap" style="display:none">
            <label for="holderSecret">Holder Secret</label>
            <input type="password" id="holderSecret" name="holderSecret" placeholder="sEd…" />
            <button type="button" class="reveal btn btn-primary" data-toggle="holderSecret">Show</button>
          </div>

          <div class="col-12" id="holderAddressWrap">
            <label for="holderAddress">Investor Address (r…)</label>
            <input
              type="text"
              id="holderAddress"
              name="holderAddress"
              placeholder="r..."
              pattern="^r[1-9A-HJ-NP-Za-km-z]{25,34}$"
              autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false"
            />
            <div class="hint">Use Investor Address for issuer-only mode, or Holder Secret for classic.</div>
          </div>
        </div>
      </fieldset>

      <!-- Side-by-side: Token & Trustline | Network -->
      <div class="col-12 two-up">
        <fieldset>
          <legend>Token & TrustLine</legend>
          <div class="row">
            <div class="col-6">
              <label for="currencyCode">Currency Code</label>
              <input type="text" id="currencyCode" name="currencyCode" placeholder="GDCP20251110" required />
            </div>
            <div class="col-6">
              <label for="amount">Amount</label>
              <input type="number" id="amount" name="amount" placeholder="10000000" required />
            </div>
            <div class="col-6" id="limitWrap" style="display:none">
              <label for="limit">Trust Limit</label>
              <input type="number" id="limit" name="limit" placeholder="100000000" />
              <div class="hint">Required only in classic mode (creating trustline).</div>
            </div>
            <div class="col-6">
              <label for="freeze">Freeze after payment?</label>
              <select id="freeze" name="freeze">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
          </div>
        </fieldset>

        <fieldset>
          <legend>Network</legend>
          <div class="row">
            <div class="col-6">
              <label for="network">Network</label>
              <select id="network" name="network">
                <option value="mainnet1">mainnet1</option>
                <option value="mainnet2">mainnet2</option>
                <option value="testnet" selected>testnet</option>
              </select>
            </div>
            <div class="col-6">
              <label for="verbose">Verbose</label>
              <select id="verbose" name="verbose">
                <option value="true">true</option>
                <option value="false" selected>false</option>
              </select>
            </div>
          </div>
        </fieldset>
      </div>

      <div class="controls">
        <button id="submitBtn" type="submit" class="btn btn-primary">Submit</button>
        <button id="resetBtn" type="button" class="btn btn-ghost">Reset</button>
      </div>

      <div id="banner" class="banner"></div>
      <pre id="output" class="col-12">(waiting)</pre>
    </form>
  </div>

  <!-- XRPL browser bundle for seed → address derivation -->
  <script src="https://unpkg.com/xrpl@2.14.0/dist/browser/xrpl-latest-min.js"></script>

  <script>
    // Live classic address preview (issuer seed → r... address)
    (function () {
      const seedEl = document.getElementById('issuerSecret');
      const rowEl  = document.getElementById('issuerAddrRow');
      const textEl = document.getElementById('issuerAddrText');

      function showAddr(addr){ rowEl.style.display='block'; textEl.textContent = addr; }
      function showInvalid(msg){ rowEl.style.display='block'; textEl.textContent = 'Invalid seed — ' + msg; }

      function updateAddr() {
        const seed = (seedEl.value || '').trim();
        if (!seed) { rowEl.style.display='none'; textEl.textContent=''; return; }
        try {
          if (!window.xrpl || !xrpl.Wallet) { showInvalid('XRPL library not available'); return; }
          const w = xrpl.Wallet.fromSeed(seed);
          showAddr(w.classicAddress);
        } catch (e) {
          showInvalid(e && e.message ? e.message : 'incorrect');
        }
      }

      document.addEventListener('DOMContentLoaded', updateAddr);
      seedEl.addEventListener('input', updateAddr);
    })();
  </script>

  <script>
    // Core form logic (unchanged except defaults for issuer-only mode + layout toggles)
    const form = document.getElementById('txForm');
    const output = document.getElementById('output');
    const banner = document.getElementById('banner');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');

    const mode = document.getElementById('mode');
    const holderSecretWrap = document.getElementById('holderSecretWrap');
    const holderAddressWrap = document.getElementById('holderAddressWrap');
    const limitWrap = document.getElementById('limitWrap');

    // Toggle password visibility
    document.querySelectorAll('.reveal').forEach(btn => {
      btn.addEventListener('click', () => {
        const id = btn.getAttribute('data-toggle');
        const input = document.getElementById(id);
        const type = input.type === 'password' ? 'text' : 'password';
        input.type = type;
        btn.textContent = type === 'password' ? 'Show' : 'Hide';
      });
    });

    function applyMode() {
      const issuerOnly = mode.value === 'issuer-only';
      holderSecretWrap.style.display = issuerOnly ? 'none' : 'block';
      holderAddressWrap.style.display = issuerOnly ? 'block' : 'none';
      limitWrap.style.display = issuerOnly ? 'none' : 'block';
      if (issuerOnly) { document.getElementById('holderSecret').value=''; }
      else { document.getElementById('holderAddress').value=''; }
    }
    mode.addEventListener('change', applyMode);
    // default to issuer-only on load
    document.addEventListener('DOMContentLoaded', applyMode);

    resetBtn?.addEventListener('click', () => {
      form.reset();
      applyMode();
      output.textContent = '(waiting)';
      banner.className = 'banner';
      banner.textContent = '';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      banner.className = 'banner';
      banner.textContent = '';
      output.textContent = 'Submitting…';
      submitBtn.disabled = true;

      const issuerOnly = mode.value === 'issuer-only';
      const holderSecret = issuerOnly ? '' : (form.holderSecret?.value || '');

      const data = {
        issuerSecret: form.issuerSecret.value,
        holderSecret: holderSecret || undefined,
        currencyCode: form.currencyCode.value,
        amount: form.amount.value,
        limit: form.limit.value,
        freeze: form.freeze.value === 'true',
        network: form.network.value,
        verbose: form.verbose.value === 'true'
      };
      if ('limit' in data && (data.limit === '' || data.limit == null)) delete data.limit;

      const CLASSIC_ADDR = /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/;
      const cleanAddr = (a) => (a ?? '').trim().replace(/\u200B/g, '');

      if (issuerOnly) {
        const addr = cleanAddr(document.querySelector('#holderAddress')?.value ?? '');
        if (!addr || !CLASSIC_ADDR.test(addr)) {
          banner.className = 'banner err';
          banner.textContent = 'Investor address format looks invalid.';
          output.textContent = '(address pattern mismatch)';
          submitBtn.disabled = false;
          return;
        }
        data.investorAddress = addr;
      }

      if (!issuerOnly && !data.holderSecret) {
        banner.className = 'banner err';
        banner.textContent = 'Holder secret is required in classic mode.';
        output.textContent = '(missing holder secret)';
        submitBtn.disabled = false;
        return;
      }

      try {
        const res = await fetch('/api/xrpl/execute', {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)
        });
        const contentType = res.headers.get('content-type') || '';
        const raw = await res.text();
        const parsed = contentType.includes('application/json') ? (JSON.parse(raw || '{}')) : raw;

        if (!res.ok) {
          banner.className = 'banner err';
          banner.textContent = `HTTP ${res.status} ${res.statusText}`;
          output.textContent = typeof parsed === 'string' ? raw : JSON.stringify(parsed, null, 2);
          return;
        }
        banner.className = 'banner ok';
        banner.textContent = 'Success';
        output.textContent = typeof parsed === 'string' ? raw : JSON.stringify(parsed, null, 2);
      } catch (err) {
        banner.className = 'banner err';
        banner.textContent = 'Network error';
        output.textContent = 'Network/Fetch error: ' + (err?.message || err);
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
