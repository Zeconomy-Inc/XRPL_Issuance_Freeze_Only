<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>XRPL IOU Issuance Form</title>
  <style>
    :root{
      --ink:#0b1220; --muted:#516070; --line:#dbe2ea; --accent:#2e65ff; --accent-2:#1e4fe0;
      --bg:#ffffff; --field:#f6f8fb; --field-border:#cfd8e3; --ok:#0c8f55; --err:#cc2c3a;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .wrap{max-width:1200px;margin:28px auto;padding:0 24px}
    h1{font-size:40px;margin:0 0 8px}
    .sub{color:var(--muted);margin:0 0 28px}
    /* layout */
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:24px;margin:0 0 18px}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:14px}
    .col-6{grid-column:span 6}
    .col-4{grid-column:span 4}
    .col-3{grid-column:span 3}
    .col-12{grid-column:1 / -1}
    @media (max-width:900px){.grid{grid-template-columns:1fr}.col-6,.col-4,.col-3{grid-column:1 / -1}}
    /* fields */
    label{display:block;margin:12px 0 6px;font-weight:600}
    input,select{width:100%;padding:12px 14px;border:1px solid var(--field-border);border-radius:var(--radius);background:#fff;color:var(--ink);outline:none}
    input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(46,101,255,.14)}
    .hint{font-size:13px;color:var(--muted);margin-top:6px}
    .inline{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
    .btn{background:var(--accent);color:#fff;border:0;border-radius:12px;padding:12px 18px;font-weight:700;cursor:pointer}
    .btn:hover{background:var(--accent-2)}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--line)}
    .showbtn{position:absolute;right:6px;top:6px}
    .secret-wrap{position:relative}
    /* status */
    .kv{font-size:14px;margin-top:6px}
    .kv b{margin-right:6px}
    .ok{color:var(--ok)}
    .err{color:var(--err)}
    pre{background:#f7f9fc;border:1px solid var(--line);border-radius:12px;padding:10px;overflow:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>XRPL IOU Issuance Form</h1>
    <p class="sub">Issue an IOU to an investor and optionally freeze the trustline after payment.</p>

    <form id="txForm" novalidate>
      <!-- top row: issuer seed, mode, investor address -->
      <div class="row">
        <div class="col-6">
          <label for="issuerSecret">Issuer Secret</label>
          <div class="secret-wrap">
            <input type="password" id="issuerSecret" placeholder="sEd…" autocomplete="off" />
            <button type="button" id="toggleIssuer" class="btn showbtn">Show</button>
          </div>
          <div class="kv" id="issuerAddressRow"><b>Address:</b> <span id="issuerAddressTxt" class="err">Invalid seed</span></div>
          <div class="hint">Seed never leaves your browser except when you submit.</div>
        </div>

        <div class="col-3">
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="issuer-only" selected>Issuer seed + investor address (issue &amp; freeze)</option>
            <option value="both">Both seeds (full flow)</option>
          </select>
        </div>

        <div class="col-3" id="holderAddressWrap">
          <label for="holderAddress">Investor Address (r…)</label>
          <input type="text" id="holderAddress" placeholder="r..." autocomplete="off" autocapitalize="off" spellcheck="false" />
          <div class="hint">Use either Investor Secret (classic flow) or Investor Address (issuer-only with existing trustline).</div>
        </div>
      </div>

      <!-- compact row: Token & Trustline + Network -->
      <div class="grid">
        <div>
          <div class="row">
            <div class="col-4">
              <label for="currencyCode">Currency Code</label>
              <input id="currencyCode" placeholder="GDCP20251110" />
            </div>
            <div class="col-3">
              <label for="amount">Amount</label>
              <input id="amount" type="number" placeholder="100000" />
            </div>
            <div class="col-3">
              <label for="freeze">Freeze after payment?</label>
              <select id="freeze">
                <option value="true">true</option>
                <option value="false">false</option>
              </select>
            </div>
          </div>
        </div>

        <div>
          <div class="row">
            <div class="col-4">
              <label for="network">Network</label>
              <select id="network">
                <option value="testnet" selected>testnet</option>
                <option value="mainnet1">mainnet1</option>
                <option value="mainnet2">mainnet2</option>
              </select>
            </div>
            <div class="col-3">
              <label for="verbose">Verbose</label>
              <select id="verbose">
                <option value="false" selected>false</option>
                <option value="true">true</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <div class="inline" style="margin:10px 0 16px">
        <button class="btn" id="submitBtn" type="submit">Submit</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
      </div>

      <pre id="output">(waiting)</pre>
    </form>
  </div>

  <script>
    // --- UI helpers ---
    const $ = (q) => document.querySelector(q);
    const issuerSecretEl = $('#issuerSecret');
    const issuerAddrRow  = $('#issuerAddressRow');
    const issuerAddrTxt  = $('#issuerAddressTxt');
    const toggleIssuer   = $('#toggleIssuer');

    // Show/Hide seed
    toggleIssuer.addEventListener('click', () => {
      issuerSecretEl.type = issuerSecretEl.type === 'password' ? 'text' : 'password';
      toggleIssuer.textContent = issuerSecretEl.type === 'password' ? 'Show' : 'Hide';
    });

    // Debounce
    function debounce(fn, ms){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    // Derive classic address on the server to avoid client lib issues
    async function deriveClassic(seed){
      const s = (seed||'').trim();
      if (!s) return { ok:false, reason:'empty' };
      try{
        const r = await fetch('/api/derive-key', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify({ seed:s })
        });
        if(!r.ok){
          const t = await r.text().catch(()=> '');
          return { ok:false, reason:`HTTP ${r.status}`, details:t };
        }
        const j = await r.json();
        if (j && j.address && /^r[1-9A-HJ-NP-Za-km-z]{25,34}$/.test(j.address)) {
          return { ok:true, address:j.address };
        }
        return { ok:false, reason:'bad_response' };
      }catch(e){
        return { ok:false, reason:String(e && e.message || e) };
      }
    }

    const updateDerived = debounce(async () => {
      const seed = issuerSecretEl.value;
      issuerAddrTxt.textContent = 'Deriving…';
      issuerAddrTxt.className = '';
      const r = await deriveClassic(seed);
      if (r.ok){
        issuerAddrTxt.textContent = r.address;
        issuerAddrTxt.className = 'ok';
      } else {
        issuerAddrTxt.textContent = 'Invalid seed';
        issuerAddrTxt.className = 'err';
      }
    }, 250);

    issuerSecretEl.addEventListener('input', updateDerived);
    document.addEventListener('DOMContentLoaded', updateDerived);

    // --- Form submission (unchanged flow) ---
    const form = document.getElementById('txForm');
    const output = document.getElementById('output');
    const submitBtn = document.getElementById('submitBtn');
    const resetBtn = document.getElementById('resetBtn');

    resetBtn.addEventListener('click', () => {
      form.reset();
      issuerAddrTxt.textContent = 'Invalid seed';
      issuerAddrTxt.className = 'err';
      output.textContent = '(waiting)';
      toggleIssuer.textContent = 'Show';
      issuerSecretEl.type = 'password';
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      submitBtn.disabled = true;
      output.textContent = 'Submitting…';

      const data = {
        issuerSecret: issuerSecretEl.value,
        investorAddress: document.getElementById('holderAddress').value.trim(),
        currencyCode: document.getElementById('currencyCode').value.trim(),
        amount: document.getElementById('amount').value.trim(),
        freeze: document.getElementById('freeze').value === 'true',
        network: document.getElementById('network').value,
        verbose: document.getElementById('verbose').value === 'true'
      };

      try{
        const res = await fetch('/api/xrpl/execute', {
          method:'POST',
          headers:{'content-type':'application/json'},
          body: JSON.stringify(data)
        });
        const txt = await res.text();
        const isJSON = (res.headers.get('content-type')||'').includes('application/json');
        output.textContent = isJSON ? JSON.stringify(JSON.parse(txt), null, 2) : txt;
      }catch(err){
        output.textContent = 'Network/Fetch error: ' + (err?.message || err);
      }finally{
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
